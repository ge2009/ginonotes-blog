---
title: Oracle æœ¬åœ°éƒ¨ç½² RMAN å¤‡ä»½è„šæœ¬å®šæ—¶å¤‡ä»½æ•°æ®åº“
description: è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Oracle RMAN è¿›è¡Œæ•°æ®åº“å¤‡ä»½ï¼ŒåŒ…æ‹¬å½’æ¡£æ¨¡å¼è®¾ç½®ã€å¤‡ä»½è„šæœ¬ç¼–å†™å’Œå®šæ—¶ä»»åŠ¡é…ç½®
date: 2024-01-24
category: oracle
tags: oracle, rman, backup, database, linux
cover: /covers/generated/oracle-rman-backup-script-guide.svg
---

# Oracle æœ¬åœ°éƒ¨ç½² RMAN å¤‡ä»½è„šæœ¬å®šæ—¶å¤‡ä»½æ•°æ®åº“

æƒ³å¿…å¤§å®¶éƒ½å¬è¿‡ä¸€å¥è¯ï¼šå¤‡ä»½æ˜¯æ•°æ®å®‰å…¨çš„æœ€åä¸€é“é˜²çº¿ã€‚æ•°æ®åº“æ˜¯æ•´ä¸ªç³»ç»Ÿä»¥åŠå…¬å¸æœ€é‡è¦çš„æ•°æ®å­˜æ”¾ä»“åº“ï¼Œå¦‚æœæ•°æ®æŸåä¸¢å¤±ï¼Œå°†ç›´æ¥å½±å“åˆ°å…¬å¸ä¸šåŠ¡ä»¥åŠè´¢äº§çš„æŸå¤±ï¼ŒOracle RMAN æ˜¯å®˜æ–¹æ¨å‡ºæœ€æµè¡Œçš„åœ¨çº¿çƒ­å¤‡æ–¹å¼ï¼Œå®‰å…¨é«˜æ•ˆï¼Œéƒ¨ç½²ç®€å•ã€‚

![DALLÂ·E 2024-01-12 17.24.43 - A futuristic, technology-themed image emphasizing database data backup. The central focus is on a large, glowing digital sphere representing an Oracle](https://alist.v2ex.com.cn/d/139pan/images/DALL%C2%B7E%202024-01-12%2017.24.43%20-%20A%20futuristic%2C%20technology-themed%20image%20emphasizing%20database%20data%20backup.%20The%20central%20focus%20is%20on%20a%20large%2C%20glowing%20digital%20sphere%20representing%20an%20Oracle.png)

# ä¸€ã€Oracle RMAN

åœ¨è®²è§£å¦‚ä½•ä½¿ç”¨ RMAN è¿›è¡Œå¤‡ä»½ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ RMAN å¤‡ä»½å§ï¼Recovery Manager (RMAN) æ˜¯ä¸€ä¸ª Oracle æ•°æ®åº“å®¢æˆ·ç«¯ï¼Œå¯ä»¥å¯¹æ•°æ®åº“æ‰§è¡Œå¤‡ä»½å’Œæ¢å¤ä»»åŠ¡ï¼Œå¹¶è‡ªåŠ¨ç®¡ç†æ•°æ®åº“å¤‡ä»½ç­–ç•¥ï¼Œæå¤§åœ°ç®€åŒ–äº†å¤‡ä»½ã€è¿˜åŸå’Œæ¢å¤æ•°æ®åº“æ–‡ä»¶ã€‚

> å…³äº Oracle RMAN çš„å…¥é—¨ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š**[RMAN å…¥é—¨](https://docs.oracle.com/en/database/oracle/oracle-database/21/bradv/getting-started-rman.html#GUID-871FF5B2-C82B-462E-8182-FA28CF7B3E3B)** å†™çš„å¾ˆè¯¦ç»†ï¼Œæˆ‘è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

![img](http://qiniu.v2ex.com.cn/upload2023/1badde92fefa4ea99ebe4bff0aee669e.png)

æœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•åœ¨ä¸»æœºä¸Šéƒ¨ç½² Oracle RMAN å¤‡ä»½è„šæœ¬ã€‚

# äºŒã€éƒ¨ç½²å¤‡ä»½è„šæœ¬

Oracle RMAN åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸€èˆ¬éƒ½æ˜¯çƒ­å¤‡çš„æ–¹å¼ï¼Œå†·å¤‡éœ€è¦å…³æ‰æ•°æ®åº“æ‰å¯ä»¥è¿›è¡Œï¼Œç”Ÿäº§ç¯å¢ƒä¸€èˆ¬æ˜¯æ²¡æœ‰åœæœºæ—¶é—´ç»™ä½ åšå¤‡ä»½çš„ï¼Œæ‰€ä»¥å†·å¤‡ä¸å¤ªé€‚åˆç”Ÿäº§å¤‡ä»½ã€‚çƒ­å¤‡çš„æ–¹å¼éœ€è¦æ‰“å¼€å½’æ¡£æ¨¡å¼ï¼

## 1ã€æ‰“å¼€æ•°æ®åº“å½’æ¡£æ¨¡å¼

å¦‚æœæ•°æ®åº“å·²æ‰“å¼€å½’æ¡£æ¨¡å¼ï¼Œæ‰§è¡Œ `archive log list` å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç»“æœï¼š

![å½’æ¡£æ¨¡å¼æŸ¥çœ‹](http://qiniu.v2ex.com.cn/upload2023/e5d99ddd38fb4215a9f423cfa7bca5cd.png)

å¦‚æœæœªæ‰“å¼€å½’æ¡£æ¨¡å¼ï¼Œä¸€èˆ¬ç»“æœæ˜¾ç¤ºå¦‚ä¸‹ï¼š

![æœªå½’æ¡£](http://qiniu.v2ex.com.cn/upload2023/c68009e13ee24e528ef200f105aa0399.png)

æ‰“å¼€æ•°æ®åº“å½’æ¡£æ¨¡å¼éœ€è¦é‡å¯æ•°æ®åº“ï¼Œå®Œæ•´æ­¥éª¤å¦‚ä¸‹ï¼š

```
-- è®¾ç½®å½’æ¡£æ—¥å¿—è·¯å¾„
alter system set log_archive_dest_1='LOCATION=/archivelog';
-- å…³é—­æ•°æ®åº“ï¼Œé‡å¯è‡³mountæ¨¡å¼
shutdown immediate
startup mount
-- å¼€å¯å½’æ¡£æ¨¡å¼
alter database archivelog;
-- æ‰“å¼€æ•°æ®åº“
alter database open;
-- æ£€æŸ¥å½’æ¡£æ¨¡å¼æ˜¯å¦æ‰“å¼€
archive log list
```

![é‡å¯æ•°æ®åº“æŸ¥çœ‹](http://qiniu.v2ex.com.cn/upload2023/e9a0e1710ff34e1ba73cf826004e5450.png)

å¦‚ä¸Šå›¾ï¼Œæ•°æ®åº“æ‰“å¼€å½’æ¡£æ¨¡å¼ä¹‹åï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹éƒ¨ç½² RMAN è„šæœ¬è¿›è¡Œåœ¨çº¿å¤‡ä»½äº†ã€‚

ç”±äºæ‰“å¼€å½’æ¡£æ¨¡å¼åä¼šæºæºä¸æ–­çš„äº§ç”Ÿå½’æ¡£æ—¥å¿—ï¼Œæ‰€ä»¥å»ºè®®éƒ¨ç½²ä¸€ä¸ªå®šæœŸåˆ é™¤å½’æ¡£çš„ä»»åŠ¡ï¼š

```
## oracle ç”¨æˆ·ä¸‹æ‰§è¡Œ
SCRIPTSDIR=/home/oracle/scripts
mkdir -p ${SCRIPTSDIR}
{
  echo '#!/bin/bash'
  echo 'source ~/.bash_profile'
  echo 'deltime=`date +"20%y%m%d%H%M%S"`'
  echo "rman target / nocatalog msglog ${SCRIPTSDIR}/del_arch_\${deltime}.log<<EOF"
  echo 'crosscheck archivelog all;'
  echo "delete noprompt archivelog until time 'sysdate-7';"
  echo "delete noprompt force archivelog until time 'SYSDATE-10';"
  echo 'EOF'
} >>${SCRIPTSDIR}/del_arch.sh

chmod +x ${SCRIPTSDIR}/del_arch.sh

## root ç”¨æˆ·ä¸‹æ‰§è¡Œ
SCRIPTSDIR=/home/oracle/scripts
{
  echo "#00 02 * * * ${SCRIPTSDIR}/del_arch.sh"
} >>/var/spool/cron/oracle
```

## 2ã€æœ¬åœ°å¤‡ä»½è„šæœ¬

Oracle RMAN å¤‡ä»½è„šæœ¬çš„å†™æ³•å¤šç§å¤šæ ·ï¼Œæ ¹æ®ä¸åŒçš„æ•°æ®åº“ç¯å¢ƒå¯èƒ½æœ‰ä¸åŒçš„å†™æ³•ã€‚æ¯”å¦‚ç©ºé—´ä¸å¤Ÿä½¿ç”¨å‹ç¼©å¤‡ä»½ï¼Œåˆæ¯”å¦‚æ•°æ®åº“å¤ªå¤§é€‰æ‹©å¢é‡å¤‡ä»½ç­‰ç­‰æƒ…å†µï¼Œæˆ‘ä¹Ÿä¸èƒ½å…¨éƒ¨ç…§é¡¾åˆ°å¤§å®¶çš„æƒ…å†µï¼Œæ‰€ä»¥è¿™é‡Œå°±åˆ†äº«ä¸€ä¸ªæˆ‘æ¯”è¾ƒå¸¸ç”¨çš„å¤‡ä»½è„šæœ¬ï¼Œä»…ä¾›å‚è€ƒï¼è¯¥è„šæœ¬ä¸ºå¢é‡å¤‡ä»½è„šæœ¬ï¼Œåˆ†ä¸º 0 çº§å’Œ 1 çº§ï¼Œå‘¨æ—¥ 0 çº§å…¨å¤‡ï¼Œå‘¨ä¸€è‡³å‘¨å…­ 1 çº§å¤‡ä»½ã€‚

é¦–å…ˆéœ€è¦åœ¨æœ¬åœ°ç£ç›˜åˆ›å»ºä¸€ä¸ªå¤‡ä»½ç›®å½•ï¼Œéœ€è¦æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼š

```
## root ç”¨æˆ·ä¸‹æ‰§è¡Œ
mkdir /backup
chown -R oracle:oinstall /backup
chmod -R 775 /backup
```

> **ğŸ“¢ æ³¨æ„ï¼š** ä»¥ä¸‹è„šæœ¬ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ä½¿ç”¨ï¼Œåªéœ€æ³¨æ„ä¿®æ”¹å¯¹åº”çš„å¤‡ä»½è·¯å¾„å³å¯ï¼

**å‘¨æ—¥ä¸º 0 çº§å¤‡ä»½è„šæœ¬ï¼š**

```
#!/bin/bash
source ~/.bash_profile
backtime=`date +"20%y%m%d%H%M%S"`
rman target / log=/backup/level0_backup_${backtime}.log<<EOF
run {
allocate channel c1 device type disk;
allocate channel c2 device type disk;
crosscheck backup;
crosscheck archivelog all;
sql"alter system archive log current";
delete noprompt expired backup;
delete noprompt obsolete device type disk;
backup incremental level 0 database include current controlfile format '/backup/backlv0_%d_%T_%t_%s_%p';
backup archivelog all DELETE INPUT format '/backup/arch_%d_%T_%t_%s_%p';
release channel c1;
release channel c2;
}
EOF
```

**å‘¨ä¸€è‡³å‘¨å…­ä¸º 1 çº§å¤‡ä»½è„šæœ¬å†…å®¹ï¼š**

```
#!/bin/bash
source ~/.bash_profile
backtime=`date +"20%y%m%d%H%M%S"`
rman target / log=/backup/level1_backup_${backtime}.log<<EOF
run {
allocate channel c1 device type disk;
allocate channel c2 device type disk;
crosscheck backup;
crosscheck archivelog all;
sql"alter system archive log current";
delete noprompt expired backup;
delete noprompt obsolete device type disk;
backup incremental level 1 database include current controlfile format '/backup/backlv1_%d_%T_%t_%s_%p';
backup archivelog all DELETE INPUT format '/backup/arch_%d_%T_%t_%s_%p';
release channel c1;
release channel c2;
}
EOF
```

> **ğŸ“¢ æ³¨æ„ï¼š** å¦‚æœæœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹å¯¹åº”çš„è„šæœ¬éœ€è¦æ‰‹åŠ¨æŒ‡å®šå®ä¾‹ `export ORACLE_SID`ã€‚

è„šæœ¬åˆ›å»ºå®Œä¹‹åï¼Œè®°å¾—ç»™è„šæœ¬èµ‹äºˆå¯æ‰§è¡Œæƒé™ï¼š

```
cd /home/oracle/scripts
chmod +x dbbackup_lv0.sh
chmod +x dbbackup_lv1.sh
ls -lrth
```

![image-20240112170234925](http://qiniu.v2ex.com.cn/upload2023/image-20240112170234925.png)

## 3ã€å®šæ—¶ä»»åŠ¡

Oracle RMAN æœ¬åœ°å¤‡ä»½è„šæœ¬ä¸€èˆ¬æ˜¯ä¸å®šæ—¶ä»»åŠ¡ï¼ˆcrontabï¼‰é…åˆä½¿ç”¨ï¼Œé€‰æ‹©åˆé€‚çš„æ—¶é—´æ®µè¿›è¡Œå¤‡ä»½å¾ˆé‡è¦ï¼Œå»ºè®®å°½é‡æŒ‘é€‰ä¸šåŠ¡ç©ºé—²æˆ–è€…è´Ÿè½½è¾ƒä½çš„æ—¶é—´æ®µè¿›è¡Œå¤‡ä»½ã€‚å‡è®¾å‡Œæ™¨æ˜¯ä¸šåŠ¡ç©ºé—²æ—¶æ®µï¼Œéƒ¨ç½²å®šæ—¶ä»»åŠ¡ï¼š

```
## åœ¨ root ç”¨æˆ·ä¸‹æ‰§è¡Œ
su - root
echo "00 00 * * 0 /home/oracle/scripts/dbbackup_lv0.sh" >> /var/spool/cron/oracle
echo "00 00 * * 1,2,3,4,5,6 /home/oracle/scripts/dbbackup_lv1.sh" >> /var/spool/cron/oracle
```

![crontab](http://qiniu.v2ex.com.cn/upload2023/image-20240112170334386.png)

> **å…³äº crontab å‘½ä»¤å¯ä»¥å‚è€ƒï¼š[Linux crontab å‘½ä»¤](https://www.runoob.com/linux/linux-comm-crontab.html)**

è¿™é‡Œè®¾ç½®å¥½å®šæ—¶ä»»åŠ¡æ‰§è¡Œè„šæœ¬ï¼ŒåŸºæœ¬è„šæœ¬éƒ¨ç½²å°±å®Œæˆäº†ã€‚

# ä¸‰ã€å¤‡ä»½è„šæœ¬éªŒè¯

ä¸€èˆ¬å¤‡ä»½è„šæœ¬éƒ¨ç½²å®Œä¹‹åï¼Œå¦‚æœæ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡å¤‡ä»½æµ‹è¯•ï¼Œæ¥ä¿è¯è„šæœ¬çš„å¯æ‰§è¡Œæ€§ä»¥åŠæ­£ç¡®æ€§ï¼Œä¸‹é¢å°±ç®€å•çš„æ¥åšä¸€æ¬¡å¤‡ä»½æµ‹è¯•ï¼ŒéªŒè¯ä¸€ä¸‹å’±ä»¬çš„å¤‡ä»½è„šæœ¬æ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œï¼Ÿ

## 1ã€å¤‡ä»½æ•°æ®åº“

é¦–å…ˆéœ€è¦æ‰§è¡Œ 0 çº§å¤‡ä»½è„šæœ¬è¿›è¡Œæ•°æ®åº“çš„å¤‡ä»½ï¼Œæœ€å¥½æ”¾åœ¨åå°æ‰§è¡Œï¼š

```
sh /home/oracle/scripts/dbbackup_lv0.sh &
```

![æµ‹è¯•å¤‡ä»½åŠŸèƒ½](http://qiniu.v2ex.com.cn/upload2023/image-20240112170712515.png)

ä¹Ÿå¯ä»¥è¿æ¥åˆ° RMAN æŸ¥çœ‹å¤‡ä»½è¯¦ç»†æƒ…å†µï¼š

```
rman target /
list backup;
```

![backup](http://qiniu.v2ex.com.cn/upload2023/image-20240112171012072.png)

ä¹Ÿå¯ä»¥è¿æ¥åˆ°æ•°æ®åº“æŸ¥è¯¢è§†å›¾ï¼š

```
set line222
set pagesize1000
col status for a10
col input_type for a20
col INPUT_BYTES_DISPLAY for a10
col OUTPUT_BYTES_DISPLAY for a10 
col TIME_TAKEN_DISPLAY for a10
select input_type,
       status,
       to_char(start_time,
               'yyyy-mm-dd hh24:mi:ss'),
       to_char(end_time,
               'yyyy-mm-dd hh24:mi:ss'),
       input_bytes_display,
       output_bytes_display,
       time_taken_display,
       COMPRESSION_RATIO
  from v$rman_backup_job_details
 order by 3 desc;
```

![image-20240112171459881](http://qiniu.v2ex.com.cn/upload2023/image-20240112171459881.png)

ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹å‡ºæ•°æ®åº“å¤‡ä»½çš„æƒ…å†µï¼Œåˆ†åˆ«æœ‰2æ¬¡å¤‡ä»½ï¼Œä¸€æ¬¡æ˜¯ 18 å·è¿›è¡Œäº†å…¨å¤‡ï¼Œä¸€æ¬¡æ˜¯ 19 å·è¿›è¡Œäº†å¢é‡å¤‡ä»½ï¼Œå¤‡ä»½çŠ¶æ€ï¼Œå¤‡ä»½å¤§å°ä»¥åŠå¤‡ä»½èµ·å§‹æ—¶é—´éƒ½å¯ä»¥çœ‹åˆ°ã€‚

æ¥ç€å†æ‰§è¡Œä¸€æ¬¡ 1 çº§å¢é‡å¤‡ä»½ï¼š

```
sh /home/oracle/scripts/dbbackup_lv1.sh &
``` 